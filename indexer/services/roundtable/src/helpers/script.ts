// Sample data from the logs
import {
  FundingIndexMap,
  PerpetualPositionFromDatabase,
  PerpetualPositionStatus,
  PositionSide,
  PriceMap,
} from '@dydxprotocol-indexer/postgres';
import Big from 'big.js';

import { calculateEquity, calculateTotalPnl } from './pnl-ticks-helper';

const subaccountId = '070180e5-7da1-58b2-b7ae-15d690160a0c';
// const latestBlockHeight = 19010585;
// const latestBlockTime = new Date('2024-06-26T18:56:28.918Z');
const usdcPositionSize = new Big('63947.007662');

const openPerpetualPositionsForSubaccount: PerpetualPositionFromDatabase[] = [
  {
    id: '623d0608-240b-5cd0-a5b3-6dd1d5f22c5c',
    subaccountId,
    perpetualId: '3',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-8770',
    maxSize: '-3500',
    entryPrice: '0.57064218928164196123',
    exitPrice: undefined,
    sumOpen: '8770',
    sumClose: '0',
    createdAt: '2024-06-19T14:55:32.510Z',
    closedAt: undefined,
    createdAtHeight: '18488696',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 29, 120, 0, 0, 0, 2, 0, 0, 0, 0]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '0.047358',
  },
  {
    id: '5c7a2e82-6cfc-5115-8a7f-25224d134780',
    subaccountId,
    perpetualId: '5',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-37.3',
    maxSize: '-15',
    entryPrice: '133.98402144772117962466',
    exitPrice: undefined,
    sumOpen: '37.3',
    sumClose: '0',
    createdAt: '2024-06-23T12:28:28.384Z',
    closedAt: undefined,
    createdAtHeight: '18768820',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 30, 99, 180, 0, 0, 0, 2, 0, 0, 0, 3]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '-0.930262',
  },
  {
    id: 'b7383524-a615-5bad-b708-9b8e093b973e',
    subaccountId,
    perpetualId: '7',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-99.1',
    maxSize: '-38.9',
    entryPrice: '25.22',
    exitPrice: '25.28201816347124117053',
    sumOpen: '198.2',
    sumClose: '99.1',
    createdAt: '2024-06-23T12:29:11.973Z',
    closedAt: undefined,
    createdAtHeight: '18768858',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 30, 99, 218, 0, 0, 0, 2, 0, 0, 0, 9]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '0.012883',
  },
  {
    id: '1da7e871-a6d1-592a-a64e-381ed67db24c',
    subaccountId,
    perpetualId: '24',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-6242',
    maxSize: '-500',
    entryPrice: '0.80028212111502723486',
    exitPrice: undefined,
    sumOpen: '6242',
    sumClose: '0',
    createdAt: '2024-06-19T14:51:22.211Z',
    closedAt: undefined,
    createdAtHeight: '18488508',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 28, 188, 0, 0, 0, 2, 0, 0, 0, 1]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 30, 99, 180, 0, 0, 0, 2, 0, 0, 0, 3]),
    settledFunding: '0.006242',
  },
  {
    id: '75bf2367-bc6e-5147-be11-c00581e6004b',
    subaccountId,
    perpetualId: '27',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-2681',
    maxSize: '-130',
    entryPrice: '1.85676837001118985454',
    exitPrice: undefined,
    sumOpen: '2681',
    sumClose: '0',
    createdAt: '2024-06-19T14:50:30.074Z',
    closedAt: undefined,
    createdAtHeight: '18488468',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 28, 148, 0, 0, 0, 2, 0, 0, 0, 3]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '0.399469',
  },
  {
    id: 'e1942859-ba80-5d6f-98d2-cf0122d25341',
    subaccountId,
    perpetualId: '43',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-3566',
    maxSize: '-3566',
    entryPrice: '0.701',
    exitPrice: undefined,
    sumOpen: '3566',
    sumClose: '0',
    createdAt: '2024-06-19T14:58:28.562Z',
    closedAt: undefined,
    createdAtHeight: '18488827',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 29, 251, 0, 0, 0, 2, 0, 0, 0, 4]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 30, 99, 180, 0, 0, 0, 2, 0, 0, 0, 3]),
    settledFunding: '-0.203262',
  },
  {
    id: '88109da6-dd31-5acd-afaa-15b424c03cf8',
    subaccountId,
    perpetualId: '52',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-1610',
    maxSize: '-1287',
    entryPrice: '1.55259875776397515528',
    exitPrice: undefined,
    sumOpen: '1610',
    sumClose: '0',
    createdAt: '2024-06-19T14:59:45.514Z',
    closedAt: undefined,
    createdAtHeight: '18488887',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 30, 55, 0, 0, 0, 2, 0, 0, 0, 0]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '-0.03381',
  },
  {
    id: '06c89d02-639b-5664-8f7b-da457a45e886',
    subaccountId,
    perpetualId: '60',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-22060',
    maxSize: '-22060',
    entryPrice: '0.068',
    exitPrice: undefined,
    sumOpen: '22060',
    sumClose: '0',
    createdAt: '2024-06-19T14:57:17.579Z',
    closedAt: undefined,
    createdAtHeight: '18488771',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 29, 195, 0, 0, 0, 2, 0, 0, 0, 0]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '-0.75004',
  },
  {
    id: '9edc5040-4f5d-593a-a316-1ea26e4ac9f4',
    subaccountId,
    perpetualId: '63',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-1858',
    maxSize: '-27',
    entryPrice: '1.345',
    exitPrice: undefined,
    sumOpen: '1858',
    sumClose: '0',
    createdAt: '2024-06-24T16:57:05.863Z',
    closedAt: undefined,
    createdAtHeight: '18854975',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 66, 0, 0, 0, 2, 0, 0, 0, 4]),
    settledFunding: '0',
  },
  {
    id: '5d019914-cc08-5a56-8da9-f6b02dea439d',
    subaccountId,
    perpetualId: '64',
    side: PositionSide.SHORT,
    status: PerpetualPositionStatus.OPEN,
    size: '-31570',
    maxSize: '-31570',
    entryPrice: '0.0792',
    exitPrice: undefined,
    sumOpen: '31570',
    sumClose: '0',
    createdAt: '2024-06-19T15:01:04.024Z',
    closedAt: undefined,
    createdAtHeight: '18488943',
    closedAtHeight: undefined,
    openEventId: Buffer.from([1, 26, 30, 111, 0, 0, 0, 2, 0, 0, 0, 6]),
    closeEventId: undefined,
    lastEventId: Buffer.from([1, 31, 180, 63, 0, 0, 0, 2, 0, 0, 0, 31]),
    settledFunding: '-0.078925',
  },
];
const marketPrices: PriceMap = {
  0: '60909.76231',
  1: '3361.77635',
  2: '13.9680125',
  3: '0.552134848',
  4: '0.29958214',
  5: '135.82356527',
  6: '0.3838904009',
  7: '26.025678',
  8: '4.380006792',
  9: '70.966605',
  10: '0.12259020958',
  11: '6.790035274',
  12: '5.811713508',
  13: '9.228308676',
  14: '376.6165974',
  15: '0.12295570059',
  16: '5.188984481',
  17: '2344.259947',
  18: '0.0904728581',
  19: '23.58820589',
  20: '48.66063962',
  21: '2.75245776',
  22: '0.953859256',
  23: '6.759246301',
  24: '0.805277888',
  25: '0.2094170931',
  26: '2.346921497',
  27: '1.733306677',
  28: '0.0000124738113795',
  29: '0.353442416',
  30: '0.000017181405',
  31: '0.8274',
  32: '0.4678471199',
  33: '6.35593868',
  35: '0.7761083583',
  36: '92.91933226',
  37: '570.5617752',
  38: '2.336065573',
  39: '37.08116753',
  40: '0.5697963733',
  41: '8.13525606',
  42: '1.514545636',
  43: '0.689332761',
  44: '1.7490698853',
  45: '0.2162842939',
  46: '0.3131747301',
  47: '0.00002224525837',
  48: '0.7204272756',
  49: '7.4964',
  50: '1.698820471',
  51: '23.11401524',
  52: '1.521372268',
  53: '0.0749255184',
  54: '0.1394521111',
  55: '0.2168133064',
  56: '0.3350659736',
  57: '4.080367852',
  58: '0.5729',
  59: '0.491005049',
  60: '0.0670109795',
  61: '1.96948784',
  62: '1.980929719',
  64: '0.0766789439',
  65: '1.976194857',
  66: '3.169575537',
  67: '7.499050379',
  68: '0.3345798701',
  69: '0.0766393442',
  70: '0.0000014237804878',
  72: '0.8466670082',
  73: '0.1547834777',
  1000000: '0.999083812',
  1000001: '1.353323338',
};

const lastUpdatedFundingIndexMap: FundingIndexMap = {
  0: Big('10061.34'),
  1: Big('543.858'),
  2: Big('2.985764'),
  3: Big('0.1285959'),
  4: Big('0.0242804'),
  5: Big('28.99982'),
  6: Big('0.0708093'),
  7: Big('6.69042'),
  8: Big('1.2721'),
  9: Big('4.13646'),
  10: Big('0.02794695'),
  11: Big('1.217797'),
  12: Big('0.689199'),
  13: Big('0.441051'),
  14: Big('1.2766'),
  15: Big('0.00377638'),
  16: Big('0.78862'),
  17: Big('165.689'),
  18: Big('0.0012887'),
  19: Big('1.06049'),
  20: Big('1.69429'),
  21: Big('0.490159'),
  22: Big('0.094816'),
  23: Big('0.343845'),
  24: Big('0.124828'),
  25: Big('0.0270862'),
  26: Big('0.175539'),
  27: Big('0.375521'),
  28: Big('0.0000009835177'),
  29: Big('0.0876866'),
  30: Big('0.000000319023'),
  31: Big('0.1205733'),
  32: Big('0.0524673'),
  33: Big('0.77201'),
  35: Big('0.0219666'),
  36: Big('1.77613'),
  37: Big('-7.2966'),
  38: Big('0.028685'),
  39: Big('1.37204'),
  40: Big('0.0042681'),
  41: Big('0.0733'),
  42: Big('0.058138'),
  43: Big('0.057493'),
  44: Big('0.1512811'),
  45: Big('-0.0045601'),
  46: Big('0.0012934'),
  47: Big('0.000000393'),
  48: Big('0.0321677'),
  49: Big('0.634502'),
  50: Big('0.109547'),
  51: Big('2.15939'),
  52: Big('0.22969'),
  53: Big('0.0067454'),
  54: Big('0.0061943'),
  55: Big('-0.0004333'),
  56: Big('0.002139'),
  57: Big('0.111904'),
  58: Big('0.306223'),
  59: Big('0.110517'),
  60: Big('0.0139074'),
  61: Big('0.116049'),
  62: Big('0.119478'),
  63: Big('0.016529'),
  64: Big('-0.0002865'),
  65: Big('0.04877'),
  66: Big('-0.008642'),
  67: Big('0.166207'),
  68: Big('-0.0003235'),
  69: Big('0.0000029'),
  70: Big('0'),
  72: Big('0'),
  73: Big('0'),
};

const currentFundingIndexMap: FundingIndexMap = {
  0: Big('10055.39'),
  1: Big('543.467'),
  2: Big('2.982482'),
  3: Big('0.1286097'),
  4: Big('0.0242792'),
  5: Big('28.90172'),
  6: Big('0.0708094'),
  7: Big('6.69019'),
  8: Big('1.272176'),
  9: Big('4.13605'),
  10: Big('0.02794737'),
  11: Big('1.217986'),
  12: Big('0.689189'),
  13: Big('0.44105'),
  14: Big('1.1969'),
  15: Big('0.00377973'),
  16: Big('0.789157'),
  17: Big('165.527'),
  18: Big('0.0012886'),
  19: Big('1.0604'),
  20: Big('1.67323'),
  21: Big('0.490159'),
  22: Big('0.094765'),
  23: Big('0.343823'),
  24: Big('0.12483'),
  25: Big('0.0262726'),
  26: Big('0.175646'),
  27: Big('0.375548'),
  28: Big('0.000000985444'),
  29: Big('0.0876434'),
  30: Big('0.000000319019'),
  31: Big('0.1205725'),
  32: Big('0.0524705'),
  33: Big('0.77198'),
  35: Big('0.0219655'),
  36: Big('1.78032'),
  37: Big('-7.3177'),
  38: Big('0.0286'),
  39: Big('1.37204'),
  40: Big('0.0042682'),
  41: Big('0.07325'),
  42: Big('0.058041'),
  43: Big('0.057493'),
  44: Big('0.1512811'),
  45: Big('-0.0044936'),
  46: Big('0.0012932'),
  47: Big('0.00000039291'),
  48: Big('0.0321677'),
  49: Big('0.635787'),
  50: Big('0.109865'),
  51: Big('2.15939'),
  52: Big('0.229677'),
  53: Big('0.0067454'),
  54: Big('0.0062494'),
  55: Big('-0.0004809'),
  56: Big('0.0020542'),
  57: Big('0.113332'),
  58: Big('0.306306'),
  59: Big('0.110517'),
  60: Big('0.0139032'),
  61: Big('0.118044'),
  62: Big('0.119483'),
  63: Big('0.017067'),
  64: Big('-0.0002876'),
  65: Big('0.048771'),
  66: Big('-0.009382'),
  67: Big('0.170857'),
  68: Big('-0.0003235'),
  69: Big('0.0000157'),
  70: Big('0'),
  72: Big('0'),
  73: Big('0'),
};

// const subaccountTotalTransfersMap: { [key: string]: { [key: string]: Big } } = {
//   '070180e5-7da1-58b2-b7ae-15d690160a0c': {
//     USDC: new Big('63947.007662'),
//   },
// };
//
// const USDC_ASSET_ID = 'USDC';

// Call the functions with the provided data
const currentEquity: Big = calculateEquity(
  usdcPositionSize,
  openPerpetualPositionsForSubaccount,
  marketPrices,
  lastUpdatedFundingIndexMap,
  currentFundingIndexMap,
);
console.log('Calculated equity:', currentEquity.toFixed());

const totalPnl: Big = calculateTotalPnl(
  currentEquity,
  '100000',
);

console.log('Calculated total PnL:', totalPnl.toFixed());
